# This is the minimum version number required.
# Update this, if you use features of a newer version
fastlane_version "2.55.0"

desc 'Starts a new minor release X.^.0'
lane: start_new_release do
  begin 
    new_release
  rescue => exception
    on_error(exception)
  end
end 

lane :pr_check do
  run_tests
  danger(
    verbose: true, 
    github_api_token: ENV["GITHUB_API_TOKEN"]
  )
end

def new_release
  ensure_git_branch(branch: 'develop')
  changelog = read_changelog(changelog_path: 'CHANGELOG.md', section_identifier: '[Unreleased]')

  if !changelog.gsub(/\s+/, "").empty?
    run_tests
    bump_podspec
    pod_push(path: "MercadoPagoSDKV4.podspec", allow_warnings: true)
    create_release_pull_request
    github_release(changelog)
    communicate_build_to_slack
  else 
    communicate_no_build_to_slack
  end
end

def run_tests
  cocoapods(
    clean_install: true, 
    podfile: "./ExampleSwift/Podfile"
  )
  run_tests(
    workspace: "ExampleSwift/ExampleSwift.xcworkspace", 
    scheme: "ExampleSwift"
  )
end

def bump_podspec
  last_version = git_tags
    .select {|tag| /release\/[0-9]+\.[0-9]+\.[0-9]+/.match?(tag) }
    .sort
    .last

  new_version = bump(last_version, ENV["RELEASE_BUMP_TYPE"])
  version_bump_podspec(path: "MercadoPagoSDKV4.podspec", version_number: new_version)
end

def create_release_pull_request 
  git_commit(
    path: ["./CHANGELOG.md"]
    message: "Release #{version}"
  )
  add_git_tag(tag: "release/#{new_version}")
  push_to_git_remote(
    remote_branch: "release/#{new_version}",
    tags: true
  )
  create_pull_request(
    repo: "mercadopago/px-ios",
    title: "Release #{new_version}",
    head: "release/#{new_version}"
    base: "develop",
    body: "Release pull request to update the changelog and Podspec in branch develop."
  )
end

def github_release(changelog)
  set_github_release(
    repository_name: 'mercadopago/px-ios',
    api_token: ENV['GITHUB_TOKEN'],
    name: "Release #{new_version}",
    tag_name: "release/#{new_version}",
    description: changelog,
    commitish: last_git_commit()[:commit_hash]
  )
end

def bump(version, type)
  separator = "."
  splited_version = version.split(separator).map(&:to_i)

  if splited_version.length < 3 
    return ""
  end

  if type == "major"
    splited_version[0] += 1
    splited_version[1] = 0
    splited_version[2] = 0
  elseif type == "minor"
    splited_version[1] += 1
    splited_version[2] = 0
  elseif type == "patch"
    splited_version[2] += 1
  else 
    return ""
  end

  return splited_version.join(separator)
end

def slack_release_notification
  pod_version = version_get_podspec(path: "MercadoPagoSDKV4.podspec")
  slack(
    message: "🕺 Lib de PX publicada 💃 @px-iosers",
    username: 'Release PX',
    default_payloads: [:git_author],
    attachment_properties: {
      fields: [
        {
          title: "📲Lib Version Number",
          value: pod_version
        },{
            title: "📝What´s new? RC Notes",
            value: "https://github.com/mercadopago/px-ios/releases/tag/release/#{pod_version}"
        }, {
          title: "Release pull request (don't forget to merge it)",
          value: lane_context[SharedValues::CREATE_PULL_REQUEST_HTML_URL]
        }
      ]
    }
  )
end

def slack_nothing_to_release_notification
  slack(
    message: "There won't be a release on this week! No changes needed to be deploy (according to CHANGELOG) @px-iosers",
    username: 'Release PX'
  )
end

def on_error(exception)
  slack(
    message: "@px-iosers #{exception}", 
    username: 'Release PX', 
    success: false
  )
end